{% extends 'layout.html' %}

{% block content %}
<div class="p-4 w-full">
    <h2 class="text-2xl font-bold mb-4">Temporada: {{ season.name }} {% if season.year %}({{ season.year }}){% endif %}</h2>

    <div class="grid grid-cols-2 gap-6">
        <div>
            <h3 class="text-lg font-semibold mb-2">Carreras</h3>
            <form id="createRaceForm" class="flex gap-2 mb-4">
                <input id="raceName" placeholder="Nombre carrera (Round 1)" class="px-3 py-2 rounded bg-gray-700 text-white" />
                <input id="raceOrder" type="number" placeholder="Orden" class="px-3 py-2 rounded bg-gray-700 text-white w-20" />
                <button class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white" type="submit">Crear carrera</button>
            </form>

            <div class="space-y-2">
                {% for r in races %}
                    <a href="/races/{{ r.id }}" class="block p-3 bg-gray-800 rounded hover:bg-gray-700">{{ r.order }} — {{ r.name }} {% if r.scheduled_date %}<span class="text-xs text-gray-400">{{ r.scheduled_date }}</span>{% endif %}</a>
                {% else %}
                    <div class="text-gray-400">No hay carreras todavía.</div>
                {% endfor %}
            </div>
        </div>

        <div>
            <h3 class="text-lg font-semibold mb-2">Inscripciones de Temporada</h3>
            <div class="mb-3">
                <label class="text-xs text-gray-400">Seleccionar piloto para inscribir:</label>
                <select id="driverSelect" class="w-full mt-1 px-3 py-2 rounded bg-gray-700 text-white">
                    <option value="">-- Seleccione piloto --</option>
                    {% for d in drivers %}
                        <option value="{{ d.id }}">{{ d.nickname }} — {{ d.name }}</option>
                    {% endfor %}
                </select>
                <button id="registerSeasonBtn" class="mt-2 px-3 py-2 bg-green-600 hover:bg-green-700 rounded text-white">Inscribir piloto en temporada</button>
            </div>

            <div class="bg-gray-800 rounded p-3">
                <h4 class="text-sm font-semibold mb-2">Pilotos inscritos</h4>
                <ul class="space-y-1 text-sm text-gray-300">
                    {% for reg in registrations %}
                        <li>{{ reg.driver.nickname }} ({{ reg.driver.name }}) — num: {{ reg.number or '-' }}</li>
                    {% else %}
                        <li class="text-gray-400">Ninguno</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('createRaceForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('raceName').value.trim();
    const order = parseInt(document.getElementById('raceOrder').value) || 0;
    if (!name) return alert('Nombre requerido');
    const resp = await fetch('/api/races', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ season_id: {{ season.id }}, name, order }) });
    if (resp.ok) location.reload();
    else alert('Error creando carrera');
});

document.getElementById('registerSeasonBtn')?.addEventListener('click', async () => {
    const driver_id = document.getElementById('driverSelect').value;
    if (!driver_id) return alert('Seleciona piloto');
    const resp = await fetch(`/api/seasons/{{ season.id }}/register`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({driver_id}) });
    if (resp.ok) location.reload();
    else alert('Error al registrar');
});
</script>

{% endblock %}
